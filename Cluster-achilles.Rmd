---
title: "Cluster-achilles"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---


Steps in the workflow  
*  Read in filtered RDS objects  
*  Compare SCTransfrom v1 and v2
  *  Normalise using SCTransform
  *  Perform PCA, UMAP and clustering  
  *  Convert EnsemblIDs to gene names in SCT assay
  *  Visualise variable genes, Elbow Plot and UMAPs
  



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) #set optimal fig.width and fig.height here

library(tidyverse)
library(Seurat)
#library(biomaRt)
library(scater)
library(cowplot)
library("glmGamPoi")

```

## Import the data

Make a list of files
Remove some samples due to them failing QC
MSK1250-Ach-MB2
MSK1284 all samples


```{r}

#make a list of sample files
file_list <- list.files("RDS_objects.dir/filtered", pattern="discard_filtered_SeuratObject.rds")
names(file_list) <- str_replace(file_list, "_decontX_doublet_discard_filtered_SeuratObject.rds", "")

cat ("File list before sample removal")
cat ("\n")
names(file_list)


# create a vector of unwanted files (this could come from the yml file)
files_to_remove <- c("MSK1250-Ach-MB2", "MSK1284-Ach-Enth")

# get the positions of unwanted files in the list
positions <- match(files_to_remove, names(file_list))

# remove certain files using those names
file_list <- file_list[-c(positions)] 


cat ("\n")
cat ("File list after sample removal")
cat ("\n")
names(file_list)


```


Read in RDS files after filtering


```{r, echo=FALSE}

#Make a new list for the seurat objects
so <- list()

# generate a list of Seurat objects
for (i in 1:length(file_list)){
    
    so[[i]] <- readRDS(paste0("RDS_objects.dir/filtered/", file_list[i]))
    #set the project name (should be done in filtering workflow)
    so[[i]]@project.name <- str_replace(file_list[[i]], "_decontX_doublet_discard_filtered_SeuratObject.rds", "")
}

```


## Compare SCTransform with SCTransform v 2

Perform SCTransform
Perform the downstream steps with default parameters and using 30 PCs (this will be optimised later)

```{r}

for (i in 1:length(so)){
    
    cat ("Analysing sample", i, ":", so[[i]]@project.name)
    cat ("\n")
    
    cat("run SCTransform")
    
    so[[i]] <- SCTransform(so[[i]],
                           method = "glmGamPoi", #added to increase efficiency
                           vars.to.regress = "percent_mt") %>% 
        RunPCA(reduction.name = "sct.pca") %>% 
        FindNeighbors(dims = 1:30, reduction = "sct.pca") %>%
        RunUMAP(dims = 1:30, reduction = "sct.pca", reduction.name = "sct.umap") %>% 
        FindClusters(graph.name = "SCT_snn")
    
    so[[i]] <- SCTransform(so[[i]],
                           method = "glmGamPoi", #added to increase efficiency
                           vars.to.regress = "percent_mt", 
                           vst.flavor = "v2", 
                           new.assay.name = "SCTv2") %>% # using SCTransform v2
        RunPCA(reduction.name = "sctv2.pca") %>% 
        FindNeighbors(dims = 1:30, reduction = "sctv2.pca") %>%
        RunUMAP(dims = 1:30, reduction = "sctv2.pca", reduction.name = "sctv2.umap") %>% 
        FindClusters(graph.name = "SCTv2_snn")
}

 

```
Convert rownames of RNA and SCT assay data slots to unique names


```{r, include=FALSE}

for (i in 1:length(so)){
  
    #add gene names to SCT assay
  df <- left_join(data.frame("ensembl_gene_id" = rownames(so[[i]]@assays$SCT@data)), so[[i]]@assays$RNA@meta.features)
  rownames(so[[i]]@assays$SCT@data) <- df$unique_name
  rownames(so[[i]]@assays$SCT@counts) <- df$unique_name

  # add gene names to SCTv2 assay
  df <- left_join(data.frame("ensembl_gene_id" = rownames(so[[i]]@assays$SCTv2@data)), so[[i]]@assays$RNA@meta.features)
  rownames(so[[i]]@assays$SCTv2@data) <- df$unique_name
  rownames(so[[i]]@assays$SCTv2@counts) <- df$unique_name

}

```


### Get the top 10 variable genes and label with gene names

```{r, include = FALSE}
top10_sct <- list()
top10_sctv2 <- list()


for (i in 1:length(so)){

  top10_sct[[i]] <- data.frame("ensembl_gene_id" = VariableFeatures(so[[i]], assay = "SCT")[1:10]) %>% 
    left_join(so_test[[i]]@assays$RNA@meta.features)
  
    top10_sctv2[[i]] <- data.frame("ensembl_gene_id" = VariableFeatures(so[[i]], assay = "SCTv2")[1:10]) %>% 
    left_join(so_test[[i]]@assays$RNA@meta.features)
  
  
  
}

top10_sct
top10_sctv2
```

Plot the variable features following SCTransform and SCTransform v2


```{r, fig.width=12, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    
    p1 <- VariableFeaturePlot(so[[i]], pt.size = 0.2, assay = "SCT")+
      scale_colour_viridis_d(begin = 0, end = 0.75)
    
    p2 <- LabelPoints(plot = p1, points = top10_sct[[i]]$ensembl_gene_id, 
                      labels = top10_sct[[i]]$unique_name, 
                      repel = TRUE, xnudge = 0, ynudge = 0)+
      ggtitle("SCT")
    
    p3 <- VariableFeaturePlot(so[[i]], pt.size = 0.2, assay = "SCTv2")+
      scale_colour_viridis_d(begin = 0, end = 0.75)
    
    p4 <- LabelPoints(plot = p1, points = top10_sctv2[[i]]$ensembl_gene_id, 
                      labels = top10_sctv2[[i]]$unique_name, 
                      repel = TRUE, xnudge = 0, ynudge = 0)+
      ggtitle("SCTv2")
    
    
    p5 <- plot_grid(p2, p4, nrow = 1)
    title <- ggdraw() + draw_label(so[[i]]@project.name, fontface='bold', size = 16)
    plot_list[[i]] <- plot_grid(title, p5, ncol=1, rel_heights=c(0.1, 1))


}

title <- ggdraw() + draw_label("Variable genes following SCT/SCTv2", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 1)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```

Plot ElbowPlot

```{r, fig.width=10, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- ElbowPlot(so[[i]], reduction = "sct.pca", ndims = 50)+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Elbow Plot following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```


Plot UMAP with clustering

```{r, fig.width=10, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- DimPlot(so[[i]], reduction = "sct.umap")+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Clustering following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```







Plot the top 10 variable genes on a Vln plot

```{r}
#Create a list of project names

project_names <- list()

for (i in 1:length(so_test)){
  project_names[[i]] <- so[[i]]@project.name
}

```


```{r, fig.width=12, fig.height=10}

plot_list <- list()

#str_replace(file_list[[i]], "_decontX_doublet_discard_filtered_SeuratObject.rds", "")

for (i in 1:length(so_test)){
  
  plot_list[[i]] <- VlnPlot(so_test[[i]], features = top10[[i]]$unique_name[1:6]) 
  
}

title <- ggdraw() + draw_label("Top six variable genes", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, labels = project_names, label_size = 14, hjust = 0, vjust = 1, ncol = 1)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p

```


Up to here Wed 28th Feb












From filter-achilles.Rmd

Perform denoise on the filtered object, then recalculate the UMAP on the reduced number of PCs. 

```{r, echo = FALSE}
sce_decontX_doublet_discard_filtered_denoise <- list()
df <- data.frame()

for (i in 1:length(sce_decontX_doublet_discard_filtered)){
    
    sce_decontX_doublet_discard_filtered_denoise[[i]] <-
        scran::denoisePCA(sce_decontX_doublet_discard_filtered[[i]],
                          dec_filtered[[i]], 
                          subset.row=hvg_filtered[[i]])
    
    sample <- project_title[[i]]
    denoise_PCs <- ncol(reducedDim(sce_decontX_doublet_discard_filtered_denoise[[i]], "PCA"))
    
    df[i,1] <- sample
    df[i, 2] <- denoise_PCs
    
    sce_decontX_doublet_discard_filtered_denoise[[i]] <- scater::runUMAP(sce_decontX_doublet_discard_filtered_denoise[[i]], 
                                                                 dimred = 'PCA', 
                                                                 pca = denoise_PCs,
                                                                 external_neighbors=TRUE)
    
}
    
colnames(df) <- c("sample", "number of PCs")

write.table (df, "Files/denoise_PCs.txt", row.names = FALSE, sep = "\t")

df

```

Plot the UMAPs side by side, with and without denoise.

```{r, fig.height = 12, message = FALSE}
plot_list <- list()

for (i in 1:length(sce_decontX_doublet_discard_filtered)){
    
    p1 <- plotReducedDim(sce_decontX_doublet_discard_filtered[[i]], dimred = "UMAP", colour_by = "sex")+
        scale_colour_viridis_d(begin = 0, end = 0.75)+
        ggtitle("Before denoise")+
        theme(legend.position="none")
    
    p2 <- plotReducedDim(sce_decontX_doublet_discard_filtered_denoise[[i]], dimred = "UMAP", colour_by = "sex")+
        scale_colour_viridis_d(begin = 0, end = 0.75)+
        ggtitle("After denoise")+
        theme(legend.position="none")

        p3 <- plot_grid(p1, p2, nrow = 1)
    title <- ggdraw() + draw_label(project_title[[i]], fontface='bold', size = 16)
    plot_list[[i]] <- plot_grid(title, p3, ncol=1, rel_heights=c(0.1, 1))
}


#add an overall title and arrange the graphs on one page
title <- ggdraw() + draw_label("Denoise PCA", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 24, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p
    


```

```{r, include=FALSE}
#save the plot
ggsave("Filtered_Figures.dir/Denoise_UMAP.png", p, device = "png", width = 10, height = 14, bg = "white")
ggsave("Filtered_Figures.dir/Denoise_UMAP.pdf", p, device = "pdf", width = 12, height = 24, bg = "white")
```
