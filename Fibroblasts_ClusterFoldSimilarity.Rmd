---
title: "ClusterFoldSimilarity"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

Use ClusterFoldSimilarity to compare composition of two clusters from different dataset. 
e.g. Achilles and Quads. 

https://www.biorxiv.org/content/10.1101/2024.09.27.615367v1.full
https://www.bioconductor.org/packages/release/bioc/html/ClusterFoldSimilarity.html



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(ClusterFoldSimilarity)

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(date,"_", time, "_ClusterFoldSimilarity.dir")
dir.create(directory, showWarnings = FALSE)
```

Load data

```{r}
# Achilles fibroblasts

so.achilles.fb <- readRDS("20241108_10-07_Subset_fibroblasts.dir/RDS_objects.dir/Achilles_fibroblast_subset.rds")
Idents(so.achilles.fb) <- so.achilles.fb$louvain_X_scVI_snn_res.0.3

# Quads fibroblasts

so.quads.fb <- readRDS("../20230922_quadriceps/Quads_analysis_RDS/202419_quads_fibroblasts_annotated.RDS")

so_list <- list(so.achilles.fb, so.quads.fb)
```

Run ClusterFoldSimilarity

```{r}
similarityTable <- clusterFoldSimilarity(scList=so_list, 
                                         sampleNames=c("achilles_fb", "quads_fb"),
                                         topN=1, # default
                                         topNFeatures = 1, # default
                                         nSubsampling=26) # recommended 26
```


```{r}
similarityTable
```

```{r}
quads_typeCount <- so_list[[2]][[]] %>% 
  group_by(SoupXcounts_snn_res.0.2) %>% 
  dplyr::count(fibroblastcluster_id) %>%
  arrange(desc(n), .by_group = TRUE) %>% 
  filter(row_number()==1)%>% 
    rename(fibroblastcluster_id= "clusterL")
    

similarity_subset <- similarityTable %>% select(clusterL, clusterR)
quads_typeCount <- left_join(quads_typeCount, similarity_subset) 
colnames(quads_typeCount) <- c("clusters", "quads_fb_name", "n", "achilles_match")
quads_typeCount
```

```{r}
achilles_typeCount <- so_list[[1]][[]] %>% 
  group_by(louvain_X_scVI_snn_res.0.3) %>% 
  dplyr::count(louvain_X_scVI_snn_res.0.3) %>%
  arrange(desc(n), .by_group = TRUE) %>% 
  filter(row_number()==1)%>% 
    rename(louvain_X_scVI_snn_res.0.3= "clusterL")

achilles_typeCount <- left_join(achilles_typeCount, similarity_subset) 
colnames(achilles_typeCount) <- c("louvain_X_scVI_snn_res.0.3", "n", "quads_match")
achilles_typeCount
```

Retrieve the top 5 features that contribute the most to the similarity between each pair of clusters:

```{r}
similarityTable5TopFeatures <- clusterFoldSimilarity(scList=so_list, 
                                         sampleNames=c("achilles_fb", "quads_fb"),
                                         topN=1, # obtain all possible similar clusters
                                         topNFeatures = 5, # default
                                         nSubsampling=26)
```


```{r}
similarityTable5TopFeatures
```



Retrieve all similarity values and plot heatmap
The top 2 similarities for each group within dataset 1 (heatmap row-wise) are highlighted with colored borders.

```{r}
similarityTableAllValues <- clusterFoldSimilarity(scList=so_list, 
                                         sampleNames=c("achilles_fb", "quads_fb"),
                                         topN=Inf, # obtain all possible similar clusters
                                         topNFeatures = 1, # default
                                         nSubsampling=26) # recommended 26

```

```{r, fig.width=6, fig.height=6}
ClusterFoldSimilarity::similarityHeatmap(similarityTable=similarityTableAllValues)
```



