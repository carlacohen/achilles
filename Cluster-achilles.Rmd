---
title: "Cluster-achilles"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---


Steps in the workflow  
*  Read in filtered RDS objects  
*  Compare SCTransfrom v1 and v2
  *  Normalise using SCTransform
  *  Perform PCA, UMAP and clustering  
  *  Convert EnsemblIDs to gene names in SCT assay
  *  Visualise variable genes, Elbow Plot and UMAPs
  



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE) #set optimal fig.width and fig.height here

library(tidyverse)
library(Seurat)
#library(biomaRt)
library(scater)
library(cowplot)
library("glmGamPoi")

```

## Import the data

Read in RDS files after filtering
Remove some samples due to them failing QC
OMB1250-Ach-MB2
OMB1284 all samples

```{r, echo=FALSE}
#make a list of sample files
file_list <- list.files("C:/Users/wolf1241/OneDrive - Nexus365/scflow/20230118_achilles/RDS_objects.dir/filtered", 
                        pattern=".rds")

cat ("File list before sample removal")
cat ("\n")
file_list

file_list <- file_list[c(-7, -9)]

cat ("File list after sample removal")
cat ("\n")
file_list

#Make a new list for the seurat objects
so <- list()

# generate a list of Seurat objects
for (i in 1:length(file_list)){
    
    so[[i]] <- readRDS(paste0("C:/Users/wolf1241/OneDrive - Nexus365/scflow/20230118_achilles/RDS_objects.dir/filtered/", file_list[i]))
    #set the project name (should be done in filtering workflow)
    so[[i]]@project.name <- str_replace(file_list[[i]], "_decontX_doublet_discard_filtered_SeuratObject.rds", "")
}

```


## Compare SCTransform with SCTransform v 2

Perform SCTransform
Perform the downstream steps with default parameters and using 30 PCs (this will be optimised later)

```{r}

for (i in 1:length(so)){
    
    so[[i]] <- SCTransform(so[[i]],
                           method = "glmGamPoi", #added to increase efficiency
                           vars.to.regress = "percent_mt") %>% 
      RunPCA() %>% #add reduction.name = "sct.pca" (currently "pca")
      FindNeighbors(dims = 1:30) %>%
      RunUMAP(dims = 1:30) %>% # add reduction.name = "sct.umap" (currently "umap")
      FindClusters()
    
    }

```


Plot the variable features following SCTransform


```{r, fig.width=8, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- VariableFeaturePlot(so[[i]])+
      scale_colour_viridis_d(begin = 0, end = 0.75)+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Variable genes following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```

Plot ElbowPlot

```{r, fig.width=10, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- ElbowPlot(so[[i]], ndims = 50)+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Elbow Plot following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```


Plot UMAP with clustering

```{r, fig.width=10, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- DimPlot(so[[i]], reduction = "umap")+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Clustering following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```
Plot UMAP with mitochondrial content 
## not working ##

```{r, fig.width=10, message=FALSE}
plot_list <- list()

for (i in 1:length(so)){
    
    plot_list[[i]] <- DimPlot(so[[i]], reduction = "umap", group.by = "percent_mt")+
      ggtitle(so[[i]]@project.name)
  
}

title <- ggdraw() + draw_label("Clustering following SCT", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```


Convert rownames of SCT assay data slot to unique names


```{r}
#temporarily create a new list
so_test <- so

for (i in 1:length(so_test)){
  
  df <- left_join(data.frame("ensembl_gene_id" = rownames(so_test[[i]]@assays$SCT@data)), so_test[[i]]@assays$RNA@meta.features)
  
  rownames(so_test[[i]]@assays$SCT@data) <- df$unique_name
  rownames(so_test[[i]]@assays$SCT@counts) <- df$unique_name

}

```


### Get the top 10 variable genes

```{r}
top10 <- list()

for (i in 1:length(so_test)){

  top10[[i]] <- data.frame("ensembl_gene_id" = VariableFeatures(so_test[[i]])[1:10]) %>% 
    left_join(so_test[[i]]@assays$RNA@meta.features)
}

```


Plot the top 10 variable genes on a Vln plot

```{r}
#Create a list of project names

project_names <- list()

for (i in 1:length(so_test)){
  project_names[[i]] <- so[[i]]@project.name
}

```


```{r, fig.width=12, fig.height=10}

plot_list <- list()

#str_replace(file_list[[i]], "_decontX_doublet_discard_filtered_SeuratObject.rds", "")

for (i in 1:length(so_test)){
  
  plot_list[[i]] <- VlnPlot(so_test[[i]], features = top10[[i]]$unique_name[1:6]) 
  
}

title <- ggdraw() + draw_label("Top six variable genes", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, labels = project_names, label_size = 14, hjust = 0, vjust = 1, ncol = 1)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p

```


Up to here Friday 17th Feb


```{r}
so[[1]]@assays$RNA@meta.features %>% head()

so_unfiltered_test <- readRDS("RDS_objects.dir/OMB1250-Ach-MB1_unfiltered_SeuratObject.rds")
so_unfiltered_test@assays$RNA@meta.features %>% head()


```

NB this section can be removed once fixed in QC-1 and re-run
Access biomaRT to get a mapping of EnsemblIDs to gene names

```{r, echo=FALSE}

# Access the useMart database
# useMart keeps not working every so often (issue https://github.com/grimbough/biomaRt/issues/31)
ensembl <- try(useMart("ensembl", dataset = "hsapiens_gene_ensembl"))
if(class(ensembl) == "try-error"){
  httr::set_config(httr::config(ssl_verifypeer = FALSE))
  ensembl <- useMart("ensembl", dataset = "hsapiens_gene_ensembl")
}

# get a df of ensemble_id vs gene symbol
mapping <- getBM(attributes = c("ensembl_gene_id", "hgnc_symbol"), mart = ensembl)
```

### Add gene symbols to the meta.features of the RNA assay

Where no gene symbol is available, leave in the EnsemblID  
For the Seurat object this has to be added for each assay.  
For Bioconductor SingleCellExperiment this can be added as rowData.  


```{r, echo=FALSE, message = FALSE}

df <- list()
for(i in 1:length(so)){
    
    #make a df with ensemble_id and hgnc_symbol
    df[[i]] <- data.frame("ensembl_gene_id" = rownames(so[[i]])) %>% 
        left_join(mapping)
    
    
    #add a column of unique names, remove the "_" from ensembl_ids
    df[[i]]$unique_name <- uniquifyFeatureNames(df[[i]]$ensembl_gene_id, df[[i]]$hgnc_symbol)
    df[[i]]$unique_name <- gsub("^_", "", df[[i]]$unique_name)
    df[[i]] <- df[[i]] %>% distinct(ensembl_gene_id, .keep_all = TRUE) #remove duplicated rows
    print(head(df[[i]]))
    
    #add ensembl_IDs to row names
    rownames(df[[i]]) <- rownames(so[[i]])
    
    #add to the meta.features in the RNA assay
    so[[i]][["RNA"]]@meta.features <- df[[i]]
    print(head(so[[i]][["RNA"]]@meta.features))
    
}

```

? can we transfer the names from RNA to SCT assay?

Plot variable features

```{r}


plot_list <- list()

for (i in 1:length(so)){
    
    top10 <- head(VariableFeatures(so[[i]]), 10)
    
    plot1 <- VariableFeaturePlot(so[[i]])
  
  # label with gene names
  plot_list[[i]] <- LabelPoints(plot = plot1, points = top10, #labels = top10_genes$hgnc_symbol, 
                       repel = TRUE, xnudge = 0, ynudge = 0)

  print(plot_list[[i]])

    
    }


```



Visualise VlnPlots before and afer SCTransform

```{r}

plot_list <- list()

for (i in 1:length(so)) {
    
    # do a violin plot
    plot_list[[i]] <- VlnPlot(so[[i]], c("nCount_RNA", "nCount_SCT"), pt.size = 0)+
        theme(legend.position="none")
    print(plot_list[[i]])
}

```

? Do we need to add gene  names to the SCT assay?


Run PCA and do the Elbow plot to check how many dimensions we should use going forward


```{r}

plot_list <- list()

for (i in 1:length(so)) {
    
    #Calculate PCA
    so[[i]] <- RunPCA(so[[i]], reduction.name = "sct.pca")
    
    #do elbow plot
    plot_list[[i]] <- ElbowPlot(so[[i]], ndims = 50)
    print(plot_list[[i]])
}



```

Run tSNE and UMAP on the selected number of PCs. 
Might this be different for different samples?


```{r}
for (i in 1:length(so)) {
    
    so[[i]] <- RunUMAP(seurat_after_qc,
                       reduction = "sct.pca",
                       dims = 1:20,
                       reduction.name = "sct.umap")
    so[[i]] <- RunTSNE()
    
}
```




From filter-achilles.Rmd

Perform denoise on the filtered object, then recalculate the UMAP on the reduced number of PCs. 

```{r, echo = FALSE}
sce_decontX_doublet_discard_filtered_denoise <- list()
df <- data.frame()

for (i in 1:length(sce_decontX_doublet_discard_filtered)){
    
    sce_decontX_doublet_discard_filtered_denoise[[i]] <-
        scran::denoisePCA(sce_decontX_doublet_discard_filtered[[i]],
                          dec_filtered[[i]], 
                          subset.row=hvg_filtered[[i]])
    
    sample <- project_title[[i]]
    denoise_PCs <- ncol(reducedDim(sce_decontX_doublet_discard_filtered_denoise[[i]], "PCA"))
    
    df[i,1] <- sample
    df[i, 2] <- denoise_PCs
    
    sce_decontX_doublet_discard_filtered_denoise[[i]] <- scater::runUMAP(sce_decontX_doublet_discard_filtered_denoise[[i]], 
                                                                 dimred = 'PCA', 
                                                                 pca = denoise_PCs,
                                                                 external_neighbors=TRUE)
    
}
    
colnames(df) <- c("sample", "number of PCs")

write.table (df, "Files/denoise_PCs.txt", row.names = FALSE, sep = "\t")

df

```

Plot the UMAPs side by side, with and without denoise.

```{r, fig.height = 12, message = FALSE}
plot_list <- list()

for (i in 1:length(sce_decontX_doublet_discard_filtered)){
    
    p1 <- plotReducedDim(sce_decontX_doublet_discard_filtered[[i]], dimred = "UMAP", colour_by = "sex")+
        scale_colour_viridis_d(begin = 0, end = 0.75)+
        ggtitle("Before denoise")+
        theme(legend.position="none")
    
    p2 <- plotReducedDim(sce_decontX_doublet_discard_filtered_denoise[[i]], dimred = "UMAP", colour_by = "sex")+
        scale_colour_viridis_d(begin = 0, end = 0.75)+
        ggtitle("After denoise")+
        theme(legend.position="none")

        p3 <- plot_grid(p1, p2, nrow = 1)
    title <- ggdraw() + draw_label(project_title[[i]], fontface='bold', size = 16)
    plot_list[[i]] <- plot_grid(title, p3, ncol=1, rel_heights=c(0.1, 1))
}


#add an overall title and arrange the graphs on one page
title <- ggdraw() + draw_label("Denoise PCA", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 24, ncol = 2)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p
    


```

```{r, include=FALSE}
#save the plot
ggsave("Filtered_Figures.dir/Denoise_UMAP.png", p, device = "png", width = 10, height = 14, bg = "white")
ggsave("Filtered_Figures.dir/Denoise_UMAP.pdf", p, device = "pdf", width = 12, height = 24, bg = "white")
```
