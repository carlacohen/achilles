---
title: "Achilles visium"
output:
  html_document:
    df_print: paged
---

Attempt to have a quick look at the Achilles visium data from each microanatomy. 

Data retrieved from: 
/project/tendonhca/shared/spatial/analysis/achilles/

Load packages

```{r}
library(Seurat)
library(tidyverse)
library(DropletUtils)
library(SpotClean)
library(SpatialExperiment)
library(scCustomize)
library(clustree)
library(CARD)
library(MuSiC)
library(corrplot)
library(cowplot)

wdir <- "/project/wolf1241/tendon_visium/"

# make a new output folder for each run, with the date & time in the directory name
date <- Sys.Date() %>% str_replace_all("-", "")
time <- format(Sys.time(), "%X") %>% str_replace_all(":", "-") %>%
    str_sub(1, 5)
directory <- paste0(wdir, date,"_", time, "_Visium.dir")
dir.create(directory, showWarnings = FALSE)
dir.create(paste0(directory, "/RDS_objects.dir/"))
dir.create(paste0(directory, "/QC_plots/"))
dir.create(paste0(directory, "/Filtering/"))
dir.create(paste0(directory, "/Processing/"))
dir.create(paste0(directory, "/Dotplots/"))
dir.create(paste0(directory, "/Spatial/"))

# set the colours
spatial.colours <- c("Fibroblasts" = "#B2182B",
                     "Mural/Endothelial/Immune" = "#35978F", 
                     "Skeletal Muscle" = "#88419D")
```

## Load data

Creat seurat objects from the raw gene x spot matrices. 


```{r Loading Data}

visium_dir <- "/project/wolf1241/tendon_visium/data.dir/"

samples <- list.files(visium_dir)
samples <- samples[2:5]

so_Enth <- Load10X_Spatial(data.dir=paste0(visium_dir, "MSK1556_Ach_Enth/outs/"), 
                         filename = "raw_feature_bc_matrix.h5", 
                         slice="MSK1556_Ach_Enth",
                         filter.matrix = FALSE)

so_MB <- Load10X_Spatial(data.dir=paste0(visium_dir, "MSK1556_Ach_MB/outs/"), 
                         filename = "raw_feature_bc_matrix.h5", 
                         slice="MSK1556_Ach_MB",
                         filter.matrix = FALSE)

so_MB2 <- Load10X_Spatial(data.dir=paste0(visium_dir, "MSK1556_Ach_MB2/outs/"), 
                         filename = "raw_feature_bc_matrix.h5", 
                         slice="MSK1556_Ach_MB2",
                         filter.matrix = FALSE)

so_MTJ <- Load10X_Spatial(data.dir=paste0(visium_dir, "MSK1556_Ach_MTJ/outs/"), 
                         filename = "raw_feature_bc_matrix.h5", 
                         slice="MSK1556_Ach_MTJ",
                         filter.matrix = FALSE)
seurat <- list(so_Enth, so_MB, so_MB2, so_MTJ)
names(seurat) <- samples
```
## READING IN AUTOMATED TISSUE DETECTION INFORMATION

So you can look at whether the spot is under the tissue or not. 
Our file is tissue_positions_list.csv not tissue_posisions.csv due to the version of spaceRanger that was used. 
https://www.10xgenomics.com/support/software/space-ranger/2.1/tutorials/outputs/spatial-outputs

```{r Reading In Automated Tissue Detection Information}

coords <- list()
for (sample in samples){
  coords[[sample]] <- read.csv(paste0(visium_dir, sample, "/outs/spatial/tissue_positions_list.csv"), header = FALSE)
  colnames(coords[[sample]]) <- c("barcode", "in_tissue", "array_row", "array_col", 
                                  "pxl_row_in_fullres", "pxl_col_in_fullres")
  
  rownames(coords[[sample]]) <- coords[[sample]]$barcode

# add this info to the metadata of the so
  seurat[[sample]]$UnderTissue <- ifelse(coords[[sample]][Cells(seurat[[sample]]), "in_tissue"], 
                             yes="Under Tissue", 
                             no="Outside Tisue")
  print(head(seurat[[sample]]$UnderTissue))
}

```

##VISUALISING THE SECTION

Use the SpatialDimPlot function to visualise the spatial data.

```{r}
for(sample in samples){
  print(SpatialDimPlot(seurat[[sample]], group.by = "UnderTissue", 
               cols = c("Under Tissue" = "blue", "Outside Tissue" = "grey")))
  ggsave(paste0(directory, "/QC_plots/", sample, "_under_tissue.png"))
  
}



```

How many features and counts per spot?


```{r}
for(sample in samples){
  print(SpatialFeaturePlot(seurat[[sample]], "nFeature_Spatial") )
  ggsave(paste0(directory, "/QC_plots/", sample, "_nFeature_Spatial.png"))
}
```

```{r Visualising Gene Detection Rate}
for(sample in samples){
  print(SpatialFeaturePlot(seurat[[sample]], "nCount_Spatial"))
  ggsave(paste0(directory, "/QC_plots/", sample, "_nCount_Spatial.png"))
}

```

## Calculate QC metrics

% ribo and % mito are added to the metadata 

```{r Calculating Addition QC Metrics}

for(sample in samples){
  seurat[[sample]] <- PercentageFeatureSet(seurat[[sample]], 
                               pattern="^RP", 
                               col.name = "percent.rp")

seurat[[sample]] <- PercentageFeatureSet(seurat[[sample]], 
                               pattern="^MT-", 
                               col.name =  "percent.mt")
}


# seurat[[]]
```
## Visualise QC metrics

```{r}

for(sample in samples){
  print(SpatialFeaturePlot(seurat[[sample]], "percent.rp") )
  ggsave(paste0(directory, "/QC_plots/", sample, "_percentrp.png"))
}

```

```{r}

for(sample in samples){
  print(SpatialFeaturePlot(seurat[[sample]], "percent.mt"))
  ggsave(paste0(directory, "/QC_plots/", sample, "_percentmt.png"))
}

```

```{r}

for(sample in samples){
  print(QC_Histogram(seurat[[sample]], features = "percent.mt"))
  ggsave(paste0(directory, "/QC_plots/", sample, "_percentmt_histogram.png"))
}

```
```{r}

for(sample in samples){
  print(QC_Histogram(seurat[[sample]], features = "percent.rp") )
  ggsave(paste0(directory, "/QC_plots/", sample, "_percentrp_histogram.png"))
}


```


## Filtering

Optimise filtering to remove poor quality spots. 
First filter by nFeatures to 80
NB this section visualises the potential filtering but doesn't actually filter anything. 
Using NFeatures > 80 seems to more or less select spots that are in the tissue. 

```{r}

for(sample in samples){
  # plot the proposed threshold
  print(QC_Histogram(seurat[[sample]], "nFeature_Spatial", low_cutoff = 80 ))
  ggsave(paste0(directory, "/Filtering/", sample, "_nFeature_Spatial_filter_histogram.png"))
  
  # add this threshold to the metadata
  seurat[[sample]]$SpotFilter <- seurat[[sample]]$nFeature_Spatial > 80 
  # add ribo and mito filters
  seurat[[sample]]$MitoFilter <- seurat[[sample]]$percent.mt < 10
  seurat[[sample]]$RiboFilter <- seurat[[sample]]$percent.rp < 20
  
  # visualise which spots would be removed by the filter
  print(SpatialDimPlot(seurat[[sample]], group.by = "SpotFilter"))
  ggsave(paste0(directory, "/Filtering/", sample, "_nFeature_Spatial.png"))
}
#seurat[[1]][[]]
```

## Plot the distribution of gene and molecule detection rate under and outside tissue covered areas.

We can see there is a fair bit of overlap. 
Can use this info to help set the filters. 


```{r}
for(sample in samples){
  print(ggplot(seurat[[sample]][[]], aes(nFeature_Spatial, colour=UnderTissue)) + 
          geom_density() + geom_vline(xintercept = 80))
  ggsave(paste0(directory, "/Filtering/", sample, "_nFeature_under_tissue.png"))
  print(ggplot(seurat[[sample]][[]], aes(nCount_Spatial, colour=UnderTissue)) + 
          geom_density()+ geom_vline(xintercept = 80))
  ggsave(paste0(directory, "/Filtering/", sample, "_nCounts_under_tissue.png"))
}
```


### Filtering

Filter the data to include
- only spots under the histology
- spots with >80 features 
- % mito <10
- % ribo <20
These were defined previously.
```{r, warning = FALSE}
for (sample in samples){
  seurat[[sample]] <- subset(seurat[[sample]], 
                             UnderTissue == "Under Tissue" & 
                               SpotFilter &
                               MitoFilter &
                               RiboFilter)
  # remove MALAT1
  genes <- rownames(seurat[[sample]])
  position <- which(genes %in% "MALAT1")
  genes <- genes[-position]

  seurat[[sample]] <- subset(seurat[[sample]], features = genes)
}
```

# Normalise with SCTransform


```{r}
for(sample in samples){
  print(sample)
  seurat[[sample]] <- SCTransform(seurat[[sample]], assay = "Spatial", return.only.var.genes = FALSE) 
  seurat[[sample]] <- RunPCA(seurat[[sample]])
  print(ElbowPlot(seurat[[sample]], 50))
  ggsave(paste0(directory, "/Processing/", sample, "_Elbow_plot.png"))
}

```

Find Neighbours and Clusters, run UMAP
NB here we are using all genes, we could subset to variable features or spatially variable features. 

```{r}
for(sample in samples){
  seurat[[sample]] <- FindNeighbors(seurat[[sample]], dims = 1:10)
  seurat[[sample]] <- FindClusters(seurat[[sample]], resolution = seq(0.1, 0.6, 0.1))
  seurat[[sample]] <- RunUMAP(seurat[[sample]],  dims = 1:10)
}

```

Plot UMAPs at multiple clustering resolutions

```{r, fig.width=10, fig.height=16}

for (sample in samples){
  resolutionList <- grep("SCT_", colnames(seurat[[sample]][[]]), value = TRUE)
  
  plot_list <- list()
  
  for (resolution in resolutionList){
        plot_list [[resolution]] <- DimPlot(object = seurat[[sample]], label = TRUE, 
                                            reduction = "umap", group.by = resolution, shuffle = TRUE)+
            #scale_colour_viridis_d()
            theme(legend.position="none")
        }
  
  title <- ggdraw() + draw_label(paste0(sample, ": Clustering res 0.1-0.6"), fontface='bold', size = 24)
  p <- plot_grid(plotlist = plot_list, ncol = 2) 
  p <- plot_grid(title, p, ncol=1, rel_heights=c(0.05, 1))
  
  
  print(p)
  ggsave(paste0(directory, "/Processing/", sample, "_Clustering_UMAPs.png"), 
                width = 10, height = 16, bg = "white")
}
```
View the clusters on the spatial data


```{r}
for (sample in samples){
  print(SpatialDimPlot(seurat[[sample]], pt.size.factor = 2))
}

```

Do the clustree plot

```{r fig.height=10, fig.width=7}
for (sample in samples){
  print(clustree(seurat[[sample]],  node_colour = "sc3_stability")+
          ggtitle(sample))
  ggsave(paste0(directory, "/Processing/", sample, "_Clustree.png"), 
         width = 7, height = 10, bg = "white")
}

```

#### Pick resolutions

Each sample has 2 clusters at: 

Enth 0.2
MB1 0.1
MB2 0.2
MTJ 0.1

Find all markers selected resolutions

```{r}
markers <- list()

Idents(seurat[["MSK1556_Ach_Enth"]]) <- seurat[["MSK1556_Ach_Enth"]]$SCT_snn_res.0.2
markers[["MSK1556_Ach_Enth"]] <- FindAllMarkers(seurat[["MSK1556_Ach_Enth"]], only.pos = TRUE, min.pct = 0.1)


Idents(seurat[["MSK1556_Ach_MB"]]) <- seurat[["MSK1556_Ach_MB"]]$SCT_snn_res.0.1
markers[["MSK1556_Ach_MB"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MB2"]]) <- seurat[["MSK1556_Ach_MB2"]]$SCT_snn_res.0.2
markers[["MSK1556_Ach_MB2"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB2"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MTJ"]]) <- seurat[["MSK1556_Ach_MTJ"]]$SCT_snn_res.0.1
markers[["MSK1556_Ach_MTJ"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MTJ"]], only.pos = TRUE, min.pct = 0.1)



# markers
```

Use the Extract_Top_Markers function from scCustomise to select the top markers for each cluster

```{r, warning = FALSE, message= FALSE, fig.height=8, fig.width=5}
for(sample in samples){
 top <- Extract_Top_Markers(markers[[sample]], num_genes = 10, named_vector = FALSE, make_unique = TRUE)
 print(DotPlot(seurat[[sample]], features = top) + 
         scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
         coord_flip()+
         ggtitle(sample))
 ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_top.png"), 
         width = 5, height = 8, bg = "white")
}
```


Annotation dotplots at selected resolutions

```{r, fig.width=16, fig.height=6, warning = FALSE}
general_markers_top5 <- list("Fibroblast" = c("COL1A2", "COL3A1", "DCN", "NEGR1", "COMP"),
                        "Sk_musc" = c("TRDN", "TTN", "NEB", "DES", "ACTN2"), 
                        "Macrophage"  = c("F13A1", "CD163", "MRC1", "MSR1","MERTK"), 
                        "T cell"  = c( "CD247", "SKAP1", "THEMIS", "PTPRC", "IL7R"), 
                        "Granulocyte" = c("KIT", "CPA3", "IL18R1","CDK15", "MS4A2"), 
                        "B cell" = c("MS4A1", "CD37", "BLNK", "FCRL1", "IGHM"), 
                        "Plasma" = c("CD38", "CD79A", "CD79B", "SDC1", "CD27"), 
                        "VEC" = c("PECAM1", "PTPRB", "FLT1", "VWF", "ADGRL4"), 
                        "LEC" = c( "MMRN1", "PROX1", "PKHD1L1", "FLT4", "NRG3"),
                        "Mural" = c( "NOTCH3", "PDGFRB", "MYO1B", "ELN", "FBN1"), 
                        "Adipocyte"  = c ("PLIN1", "LPL", "GPAM", "AQP7","ADIPOQ"), 
                        "Cycling" = c("ASPM", "DIAPH3", "TOP2A"),
                        "Nerve" = c( "NTRK3", "KANK4", "SLC2A1", "SLC22A3", "CLDN1")
                        )

for(sample in samples){
  print(DotPlot(seurat[[sample]], features = general_markers_top5, assay = "SCT") + 
      scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
      theme(axis.text.y = element_text(size = 16))+
      theme(axis.title.x = element_blank())+
      theme(axis.title.y = element_blank())+
        ggtitle(sample))
  ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_general.png"), 
         width = 16, height = 6, bg = "white")
}
```
Annotations
Enth - 0  & 1 both FB, try higher res
MB1 - 0 fibroblasts; 1 macrophages/mural?
MB2 - 0 fibroblasts; 1 macrophages/mural?
MTJ - 0 fibroblasts; 1 macrophages/mural?


#### Pick higher resolutions

Each sample has more clusters at: 

Enth 0.4
MB1 0.5
MB2 0.4
MTJ 0.4

Find all markers selected resolutions

```{r}
markers_2 <- list()

Idents(seurat[["MSK1556_Ach_Enth"]]) <- seurat[["MSK1556_Ach_Enth"]]$SCT_snn_res.0.4
markers_2[["MSK1556_Ach_Enth"]] <- FindAllMarkers(seurat[["MSK1556_Ach_Enth"]], only.pos = TRUE, min.pct = 0.1)


Idents(seurat[["MSK1556_Ach_MB"]]) <- seurat[["MSK1556_Ach_MB"]]$SCT_snn_res.0.5
markers_2[["MSK1556_Ach_MB"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MB2"]]) <- seurat[["MSK1556_Ach_MB2"]]$SCT_snn_res.0.4
markers_2[["MSK1556_Ach_MB2"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB2"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MTJ"]]) <- seurat[["MSK1556_Ach_MTJ"]]$SCT_snn_res.0.4
markers_2[["MSK1556_Ach_MTJ"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MTJ"]], only.pos = TRUE, min.pct = 0.1)



# markers
```

Use the Extract_Top_Markers function from scCustomise to select the top markers for each cluster

```{r, warning = FALSE, message= FALSE, fig.height=8, fig.width=5}
top <- list()
for(sample in samples){
 top[[sample]] <- Extract_Top_Markers(markers_2[[sample]], num_genes = 10, named_vector = FALSE, make_unique = TRUE)
 print(DotPlot(seurat[[sample]], features = top[[sample]]) + 
         scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
         coord_flip()+
         ggtitle(sample))
 ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_top_2.png"), 
         width = 5, height = 8, bg = "white")
}


```


```{r, fig.width=16, fig.height=6, warning = FALSE}

for(sample in samples){
  print(DotPlot(seurat[[sample]], features = general_markers_top5, assay = "SCT") + 
      scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
      theme(axis.text.y = element_text(size = 16))+
      theme(axis.title.x = element_blank())+
      theme(axis.title.y = element_blank())+
        ggtitle(sample))
  ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_general_2.png"), 
         width = 16, height = 6, bg = "white")
}
```

Resolution 0.3

Find all markers selected resolutions

```{r}
markers_0.3 <- list()

Idents(seurat[["MSK1556_Ach_Enth"]]) <- seurat[["MSK1556_Ach_Enth"]]$SCT_snn_res.0.3
markers_0.3[["MSK1556_Ach_Enth"]] <- FindAllMarkers(seurat[["MSK1556_Ach_Enth"]], only.pos = TRUE, min.pct = 0.1)


Idents(seurat[["MSK1556_Ach_MB"]]) <- seurat[["MSK1556_Ach_MB"]]$SCT_snn_res.0.3
markers_0.3[["MSK1556_Ach_MB"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MB2"]]) <- seurat[["MSK1556_Ach_MB2"]]$SCT_snn_res.0.3
markers_0.3[["MSK1556_Ach_MB2"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MB2"]], only.pos = TRUE, min.pct = 0.1)

Idents(seurat[["MSK1556_Ach_MTJ"]]) <- seurat[["MSK1556_Ach_MTJ"]]$SCT_snn_res.0.3
markers_0.3[["MSK1556_Ach_MTJ"]] <- FindAllMarkers(seurat[["MSK1556_Ach_MTJ"]], only.pos = TRUE, min.pct = 0.1)

```
Use the Extract_Top_Markers function from scCustomise to select the top markers for each cluster

```{r, warning = FALSE, message= FALSE, fig.height=8, fig.width=5}
top <- list()
for(sample in samples){
 top[[sample]] <- Extract_Top_Markers(markers_0.3[[sample]], num_genes = 10, named_vector = FALSE, make_unique = TRUE)
 print(DotPlot(seurat[[sample]], features = top[[sample]]) + 
         scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
         coord_flip()+
         ggtitle(sample))
 ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_top_0.3.png"), 
         width = 5, height = 8, bg = "white")
}


```

```{r, fig.width=16, fig.height=6, warning = FALSE}

for(sample in samples){
  print(DotPlot(seurat[[sample]], features = general_markers_top5, assay = "SCT") + 
      scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
      theme(axis.text.y = element_text(size = 16))+
      theme(axis.title.x = element_blank())+
      theme(axis.title.y = element_blank())+
        ggtitle(sample))
  ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_general_0.3.png"), 
         width = 16, height = 6, bg = "white")
}
```




```{r, fig.width=16, fig.height=6, warning = FALSE}
fibroblast_markers_top3 <- list("NEGR1" = c("NEGR1", "DCLK1", "BMP5"), 
                                "COMP" = c("COMP", "ITGA10", "KLHL29"), 
                                "VCAN" = c("VCAN", "CACNB2", "ISM1"),
                                "MMP3" = c("MMP3", "FBLN1", "CILP"),
                                "COL15A1" = c("COL15A1", "GREB1L", "LRRTM4"),
                                "Chondrocyte" = c("ACAN", "COL2A1", "SDK2"),
                                "ITGA6" = c("TENM2", "ITGA6", "SHISA6"),
                                "THBS4" = c("THBS4", "NCAM1", "PIEZO2"),
                                "PRG4" = c("PRG4", "CMKLR2", "ITGB8")) 


for(sample in samples){
  print(DotPlot(seurat[[sample]], features = fibroblast_markers_top3, assay = "SCT") + 
      scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
      theme(axis.text.y = element_text(size = 16))+
      theme(axis.title.x = element_blank())+
      theme(axis.title.y = element_blank()))
  }
```

# Rename Idents where possible

### Enthesis
0/1/3 fibroblasts
2 - other non-fibroblast i.e. endothelial/immune


```{r}
seurat[["MSK1556_Ach_Enth"]] <- RenameIdents(seurat[["MSK1556_Ach_Enth"]],
                                             `0` = "Fibroblasts",
                                             `1` = "Fibroblasts", 
                                             `2` = "Mural/Endothelial/Immune",
                                             `3` = "Fibroblasts"
)

SpatialDimPlot(seurat[["MSK1556_Ach_Enth"]], pt.size.factor = 2, 
               cols = spatial.colours, 
               image.alpha = 0.5)+
  ggtitle("MSK1556_Ach_Enth")
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_Enth_Annotated.png"))
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_Enth_Annotated.svg"))
```

### MB 

0/1/3 fibroblasts
2 - other non-fibroblast i.e. endothelial/immune

```{r}
seurat[["MSK1556_Ach_MB"]] <- RenameIdents(seurat[["MSK1556_Ach_MB"]],
                                             `0` = "Fibroblasts",
                                             `1` = "Fibroblasts", 
                                             `2` = "Mural/Endothelial/Immune",
                                             `3` = "Fibroblasts"
)

SpatialDimPlot(seurat[["MSK1556_Ach_MB"]], pt.size.factor = 2, 
               cols = spatial.colours, 
               image.alpha = 0.5)+
  ggtitle("MSK1556_Ach_MB")
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MB_Annotated.png"))
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MB_Annotated.svg"))
```
### MB2 

0 - fibroblasts
1 - other non-fibroblast i.e. endothelial/immune

```{r}
seurat[["MSK1556_Ach_MB2"]] <- RenameIdents(seurat[["MSK1556_Ach_MB2"]],
                                             `0` = "Fibroblasts",
                                             `1` = "Mural/Endothelial/Immune"
)

SpatialDimPlot(seurat[["MSK1556_Ach_MB2"]], pt.size.factor = 2, cols = spatial.colours, 
               image.alpha = 0.5)+
  ggtitle("MSK1556_Ach_MB2")
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MB2_Annotated.png"))
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MB2_Annotated.svg"))
```
### MTJ

0/1 - fibroblasts
2 - muscle
3 - other non-fibroblast i.e. endothelial/immune

```{r}
seurat[["MSK1556_Ach_MTJ"]] <- RenameIdents(seurat[["MSK1556_Ach_MTJ"]],
                                             `0` = "Fibroblasts",
                                            `1` = "Fibroblasts",
                                            `2` = "Skeletal Muscle",
                                             `3` = "Mural/Endothelial/Immune"
)
SpatialDimPlot(seurat[["MSK1556_Ach_MTJ"]], pt.size.factor = 2, cols = spatial.colours, 
               image.alpha = 0.5)+
  ggtitle("MSK1556_Ach_MTJ")
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MTJ_Annotated.png"))
ggsave(paste0(directory, "/Spatial/MSK1556_Ach_MTJ_Annotated.svg"))
```
Add these idents to the metadata

```{r}
for (sample in samples){
  seurat[[sample]]$spatial_annotation <-  Idents(seurat[[sample]])
}
```


# Can we discern the two subtypes of fibroblasts from the Achilles data?

Read in the Achilles fibroblast subset

```{r}
so.fibroblast <- readRDS("/project/wolf1241/tendon_visium/data.dir/Achilles_fibroblast_subset.rds")
DimPlot(so.fibroblast, group.by = "broad_annotation_fibroblasts", reduction = "umap")
```

Find Markers on the broad annotation

```{r}
Idents(so.fibroblast) <- so.fibroblast$broad_annotation_fibroblasts
fibroblast_markers <- FindAllMarkers(so.fibroblast, assay = "soupX", 
                                     only.pos = TRUE, 
                                     min.pct = 0.25, 
                                     logfc.threshold = 0.25
                                     ) 
```
```{r, fig.width=10, fig.height=5}
fibroblast_markers_top <- Extract_Top_Markers(fibroblast_markers, num_genes = 10, 
                                              named_vector = FALSE, make_unique = TRUE)
DotPlot(so.fibroblast, features = fibroblast_markers_top) + 
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

```{r, fig.width=12, fig.height=5, warning=FALSE}
# list of fb markers for plotting

fibroblast_markers_top <- Extract_Top_Markers(fibroblast_markers, num_genes = 10)
fb.markers <- split(unname(fibroblast_markers_top),names(fibroblast_markers_top))


for(sample in samples){
  Idents(seurat[[sample]]) <- seurat[[sample]]$SCT_snn_res.0.3
  print(DotPlot(seurat[[sample]], features = fb.markers, assay = "Spatial") + 
      scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
      theme(axis.text.y = element_text(size = 16))+
      theme(axis.title.x = element_blank())+
      theme(axis.title.y = element_blank()))
  }
```


Unfortunately it is not possible to distinguish the two types of fibroblasts in this data.


#### Find Markers on annotated clusters

These can be used for annotation dotplots

```{r}
markers <- list()
for (sample in samples){
  Idents(seurat[[sample]]) <- seurat[[sample]]$spatial_annotation
  markers[[sample]] <- FindAllMarkers(seurat[[sample]], 
                                    only.pos = TRUE, min.pct = 0.1)
}

```
```{r, warning = FALSE, message= FALSE, fig.height=4, fig.width=10}
top <- list()
for(sample in samples){
 top[[sample]] <- Extract_Top_Markers(markers[[sample]], num_genes = 10, named_vector = FALSE, make_unique = TRUE)
 print(DotPlot(seurat[[sample]], features = top[[sample]]) + 
         scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
         theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
         ggtitle(sample))
 ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_top_markers_annotated.png"), 
         width = 10, height = 4, bg = "white")
}


```

Dotplot of Annotation markers
```{r, warning = FALSE, message= FALSE, fig.height=4, fig.width=12}
annotation_markers <- list("Fibroblasts" = c("COL1A1", "COL1A2", "COMP", "CILP"),
                        "Immune" = c("CXCL14", "C1QA", "HLA-DPB1", "C7"),
                        "Mural" = c("TAGLN", "ACTA2", "MYL9", "MYH11"),
                        "Endothelial" = c("VWF", "RGS5", "EGFL7", "MCAM"),
                        "Adipocytes" = c("FABP4", "CFD", "SCD", "KCTD12"),
                        "Muscle" = c("TTN", "MYH1", "MYL2", "CKM"))
                        

for(sample in samples){
 print(DotPlot(seurat[[sample]], features = annotation_markers, assay = "Spatial") + 
        geom_point(aes(size=pct.exp), shape = 21, colour="black", stroke=0.5) +
        scale_colour_gradient2(low = "#f7f3f2", mid = "#f2390a", high = "#6e1e0a", midpoint = 1)+
        theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 16))+
        theme(axis.text.y = element_text(size = 16))+
        theme(axis.title.x = element_blank())+
        theme(axis.title.y = element_blank())
       )
 ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_annotation_markers.png"), 
         width = 12, height = 4, bg = "white")
  ggsave(paste0(directory, "/Dotplots/", sample, "_Dotplot_annotation_markers.svg"),
         width = 12, height = 4, bg = "white", device = grDevices::svg)
}



```



Save objects

```{r}

for (sample in samples){
  saveRDS(seurat[[sample]], paste0(directory, "/RDS_objects.dir/", sample, ".rds"))
}

```

```{r}
sessionInfo()
```
