---
title: "Seurat workflow"
author: "Carla Cohen"
date: "`r Sys.Date()`"
output: html_document
---

# QC-2 workflow

This workflow follows the seurat qc-1 pipeline.

The main steps are as follows:  
* Read in Seurat Object from qc-1
* Filtering - more stringent than in qc-1. 
* Save Seurat Object as RDS file.
* Make QC plots post-filtering as in qc-1 pipeline.

Since we want to set unique filters for each sample, I will not run this on the pipeline with the yml file. 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(Seurat)
library(cowplot)

```


Read in Seurat Objects 

```{r}
#make a list of sample files
file_list <- list.files("RDS_objects.dir/", pattern="unfiltered_SeuratObject.rds")

#Make a new list for the seurat objects
so <- list()

# generate a list of Seurat objects
for (i in 1:length(file_list)){
    
    so[[i]] <- readRDS(paste0("RDS_objects.dir/", file_list[i]))
    
}

```


Remove some samples with too few cells

OMB1284-Ach-MB and OMB1284-Ach-MTJ have very low cell numbers (58 and 164 respectively). 


```{r}
for (i in 1:length(file_list)){
    
    print(i)
    print(so[[i]]@project.name)
}

so <- so[c(-10, -11)]


```



Filtering

Plot before filtering

```{r}
plot_list <- list()

for (i in 1:length(so)) {
    
    # do a violin plot
    plot_list[[i]] <- VlnPlot(so[[i]], c("nCount_RNA", "nFeature_RNA", "percent_mt"), pt.size = 0)+
        theme(legend.position="none")
    print(plot_list[[i]])
}


```



Start off with crude filtering on each object

Prior to assessing our metrics, we are going to perform filtering of those cells with less than 100 UMIs, keep cells with 300-6000 gene counts and with mitochondrial gene ratio < 0.1. These parameters can be updated in the yml file if required.


```{r}

so_filtered <- list()
for (i in 1:length(so)){
    
    so_filtered[[i]] <- subset(so[[i]], 
                               subset = nCount_RNA > 100 &
                                   nCount_RNA < 5000 &
                                   nFeature_RNA > 300 &
                                   nFeature_RNA < 6000 &
                                   percent_mt < 10 
    )
    
}

```



```{r}
plot_list <- list()

for (i in 1:length(so)) {
    
    # do a violin plot
    plot_list[[i]] <- VlnPlot(so_filtered[[i]], c("nCount_RNA", "nFeature_RNA", "percent_mt"), pt.size = 0)+
        theme(legend.position="none")
    print(plot_list[[i]])
}
```

### Save the RDS objects

Save as a Seurat object.   
Convert to a SingleCellExperiment and save.  

```{r, echo=FALSE}

se <- list()

for(i in 1:length(so_filtered)){
    
    #save the Seurat Object
    saveRDS(so[[i]], file = paste0("RDS_objects.dir/", so_filtered[[i]]@project.name, "_filtered_SeuratObject.rds"))
    
    #Create a single cell object
    se[[i]] <- as.SingleCellExperiment(so_filtered[[i]])
    
    # add the unique gene IDs to the rowData
    rowData(se[[i]]) <- so_filtered[[i]]@assays$RNA@meta.features
    
    # Save the single cell object
    saveRDS(se[[i]], paste0("RDS_objects.dir/", so_filtered[[i]]@project.name, "_raw_filtered_SingleCellExp.rds"))
}


```






Make plots as per QC-1

#### UMI counts per cell

Plot the number of counts per cell (nCount_RNA)

The UMI counts per cell should generally be above 500, although usable, itâ€™s still low if between 500-1000 counts. If UMIs per cell is 500-1000 counts, then the cells probably should have been sequenced more deeply.

```{r, echo=FALSE, fig.height=10}

plot_list <- list()

for (i in 1:length(so)) {
    
    # do a violin plot
    plot_list[[i]] <- VlnPlot(so_filtered[[i]], "nCount_RNA", pt.size = 0)+
        #remove text on x axis
        theme(axis.text.x = element_blank())+
        #add a title
        ggtitle(so_filtered[[i]]@project.name) +
        theme(plot.title = element_text(size = 12))+
        #remove the legend
        theme(legend.position="none")
}

#add an overall title and arrange the graphs on one page
title <- ggdraw() + draw_label("ncount_RNA filtered", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 24, ncol = 3)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```
```{r, include=FALSE}
#save the plot
ggsave("QC_Figures.dir/ncount_RNA_filtered.png", p, device = "png", height = 10, bg = "white")


```
#### Genes detected per cell

Plot the number of genes per cell (nFeature_RNA)

Seeing gene detection in the range of 500-5000 is normal for inDrop analysis. Similar expectations for gene detection as for UMI detection, although may be a bit lower than UMIs.

```{r, echo=FALSE, fig.height=10}

plot_list <- list()
for (i in 1:length(so_filtered)) {
  plot_list[[i]] <- VlnPlot(so_filtered[[i]], "nFeature_RNA", pt.size = 0)+
      theme(axis.text.x = element_blank())+
      ggtitle(so_filtered[[i]]@project.name) +
      theme(plot.title = element_text(size = 12))+
      theme(legend.position="none")
}

title <- ggdraw() + draw_label("nFeature_RNA filtered", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 3)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```


```{r, include=FALSE}
#save the plot
ggsave("QC_Figures.dir/nFeature_RNA_filtered.png", p, device = "png", width = 10, height = 10, bg = "white")


```

#### Mitochondrial counts ratio

Plot the mitochondrial content (percent_mt)

```{r, echo=FALSE, fig.height=10}

plot_list <- list()
for (i in 1:length(so_filtered)) {
  plot_list[[i]] <- VlnPlot(so_filtered[[i]], "percent_mt", pt.size = 0)+
      theme(axis.text.x = element_blank())+
      ggtitle(so_filtered[[i]]@project.name) +
      theme(plot.title = element_text(size = 12))+
      theme(legend.position="none")
}

title <- ggdraw() + draw_label("percent_mt_filtered", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 3)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 1))

p


```

```{r, include=FALSE}
#save the plot
ggsave("QC_Figures.dir/percent_mt_filtered.png", p, device = "png", bg = "white", width = 10, height = 10)


```
#### UMIs vs. genes detected 

Poor quality cells are likely to have low genes and UMIs per cell. Therefore, a poor sample is likely to have cells in the lower left of the graph. Good cells should exhibit both higher number of genes per cell and higher numbers of UMIs. We also expect similar lines with similar slopes for all samples.

Plot UMIs vs genes coloured by percent_mt

```{r, echo=FALSE, message=FALSE, fig.height=14, fig.width=14}

plot_list <- list()
for (i in 1:length(so_filtered)) {
  
    metadata <- so_filtered[[i]][[]]

    plot_list[[i]] <- metadata %>% 
        ggplot(aes(x=nCount_RNA, y=nFeature_RNA, color=percent_mt)) + 
        geom_point() + 
        stat_smooth(method=lm) +
        scale_x_log10() + 
        scale_y_log10() + 
        geom_vline(xintercept = 800) +
        ggtitle(so_filtered[[i]]@project.name) +
        theme(plot.title = element_text(size = 12))
}

title <- ggdraw() + draw_label("UMIs vs genes detected filtered", fontface='bold', size = 24)
p <- plot_grid(plotlist = plot_list, label_size = 12, ncol = 3)
p <- plot_grid(title, p, ncol=1, rel_heights=c(0.1, 2))

p


```

Save the plot
```{r, include=FALSE}
#save the plot
ggsave("QC_Figures.dir/UMI_vs_genes_mt_filtered.png", p, device = "png", bg = "white", width = 14, height = 14)


```



